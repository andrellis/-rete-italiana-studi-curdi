---
import { getCollection } from 'astro:content';
import TwitterFeed from './TwitterFeed.astro';
import LinkedInFeed from './LinkedInFeed.astro';
import FacebookFeed from './FacebookFeed.astro';
import { parseUsernames, isValidTwitterUsername, isValidLinkedInUsername, isValidFacebookUsername } from '../utils/validation';

// Get site settings with error handling
let siteSettings: any[] = [];
try {
  siteSettings = await getCollection('settings');
} catch (error) {
  console.warn('Settings collection not found or empty:', error);
}

const settings = siteSettings.length > 0 ? siteSettings[0]?.data : null;

// Get social media configuration
const showTwitter = settings?.showTwitter || false;
const showLinkedin = settings?.showLinkedin || false;
const showFacebook = settings?.showFacebook || false;

// Get and validate usernames
const twitterUsernames = parseUsernames(settings?.twitterUsernames, isValidTwitterUsername);
const linkedinUsernames = parseUsernames(settings?.linkedinUsernames, isValidLinkedInUsername);
const facebookUsernames = parseUsernames(settings?.facebookUsernames, isValidFacebookUsername);

const twitterHeight = settings?.twitterHeight || 400;
const twitterTheme = settings?.twitterTheme || 'light';
const twitterMode = settings?.twitterMode || 'embed';
const twitterSource = settings?.twitterSource || 'users';
const twitterListUrl = settings?.twitterListUrl || '';
const linkedinHeight = settings?.linkedinHeight || 400;
const linkedinMode = settings?.linkedinMode || 'embed';
const linkedinEmbedHtml = settings?.linkedinEmbedHtml || '';
const facebookHeight = settings?.facebookHeight || 400;
// Check if we have valid configuration for each platform
const validTwitter = twitterSource === 'list'
  ? (twitterListUrl && twitterListUrl.length > 0)
  : twitterUsernames.length > 0;
const validLinkedin = linkedinMode === 'embed'
  ? (linkedinEmbedHtml && linkedinEmbedHtml.trim().length > 0)
  : linkedinUsernames.length > 0;
const validFacebook = facebookUsernames.length > 0;

// Only show if at least one social media is enabled and has valid configuration
const hasSocialMedia = (showTwitter && validTwitter) || (showLinkedin && validLinkedin) || (showFacebook && validFacebook);
---

{hasSocialMedia && (
  <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
{showTwitter && (
  <div class="lg:col-span-2 xl:col-span-1">
    {twitterSource === 'list' && twitterListUrl ? (
      <TwitterFeed
        username={twitterUsernames[0] || 'x'}
        href={twitterListUrl}
        height={twitterHeight}
        theme={twitterTheme}
        title="Aggiornamenti su X"
        mode={twitterMode}
      />
    ) : (
      validTwitter && (
        <>
          <TwitterFeed
            username={twitterUsernames[0]}
            height={twitterHeight}
            theme={twitterTheme}
            title={"Aggiornamenti su X"}
            mode={twitterMode}
          />
          {twitterUsernames.length > 1 && (
            <div class="mt-3 text-sm text-gray-600">
              Altri profili:
              {twitterUsernames.slice(1).map((u, i) => (
                <>
                  {" "}
                  <a href={`https://twitter.com/${u}`} target="_blank" rel="noopener noreferrer" class="underline hover:no-underline">@{u}</a>
                  {i < twitterUsernames.slice(1).length - 1 ? "," : ""}
                </>
              ))}
            </div>
          )}
        </>
      )
    )}
  </div>
)}
    
    {showLinkedin && validLinkedin && (
      <div>
        <LinkedInFeed
          username={linkedinUsernames[0]}
          height={linkedinHeight}
          title={"Aggiornamenti su LinkedIn"}
          mode={linkedinMode}
          embedHtml={linkedinEmbedHtml}
        />
        {linkedinUsernames.length > 1 && (
          <div class="mt-3 text-sm text-gray-600">
            Altri profili:
            {linkedinUsernames.slice(1).map((u, i) => (
              <>
                {' '}<a href={`https://www.linkedin.com/company/${u}`} target="_blank" rel="noopener noreferrer" class="underline hover:no-underline">{u}</a>
                {i < linkedinUsernames.slice(1).length - 1 ? ',' : ''}
              </>
            ))}
          </div>
        )}
      </div>
    )}
    
    {showFacebook && validFacebook && (
      <div>
        {facebookUsernames.map((username) => (
          <div class={facebookUsernames.length > 1 ? "mb-6 last:mb-0" : ""}>
            <FacebookFeed 
              username={username}
              height={facebookHeight}
              title={facebookUsernames.length > 1 ? `${username}` : "Seguici su Facebook"}
            />
          </div>
        ))}
      </div>
    )}
  </div>
)}
