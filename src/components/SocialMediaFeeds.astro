---
import { getCollection } from 'astro:content';
import TwitterFeed from './TwitterFeed.astro';
import LinkedInFeed from './LinkedInFeed.astro';
import FacebookFeed from './FacebookFeed.astro';
import { parseUsernames, isValidTwitterUsername, isValidLinkedInUsername, isValidFacebookUsername } from '../utils/validation';

// Get site settings with error handling
let siteSettings: any[] = [];
try {
  siteSettings = await getCollection('settings');
} catch (error) {
  console.warn('Settings collection not found or empty:', error);
}

const settings = siteSettings.length > 0 ? siteSettings[0]?.data : null;

// Get social media configuration
const showTwitter = settings?.showTwitter || false;
const showLinkedin = settings?.showLinkedin || false;
const showFacebook = settings?.showFacebook || false;

// Get and validate usernames
const twitterUsernames = parseUsernames(settings?.twitterUsernames, isValidTwitterUsername);
const linkedinUsernames = parseUsernames(settings?.linkedinUsernames, isValidLinkedInUsername);
const facebookUsernames = parseUsernames(settings?.facebookUsernames, isValidFacebookUsername);

// Check if we have valid usernames for each platform
const validTwitter = twitterUsernames.length > 0;
const validLinkedin = linkedinUsernames.length > 0;
const validFacebook = facebookUsernames.length > 0;

const twitterHeight = settings?.twitterHeight || 400;
const twitterTheme = settings?.twitterTheme || 'light';
const linkedinHeight = settings?.linkedinHeight || 400;
const facebookHeight = settings?.facebookHeight || 400;

// Only show if at least one social media is enabled and has valid username
const hasSocialMedia = (showTwitter && validTwitter) || (showLinkedin && validLinkedin) || (showFacebook && validFacebook);
---

{hasSocialMedia && (
  <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
    {showTwitter && validTwitter && (
      <div class="lg:col-span-2 xl:col-span-1">
        {twitterUsernames.map((username) => (
          <div class={twitterUsernames.length > 1 ? "mb-6 last:mb-0" : ""}>
            <TwitterFeed 
              username={username}
              height={twitterHeight}
              theme={twitterTheme}
              title={twitterUsernames.length > 1 ? `@${username}` : "Seguici su Twitter"}
            />
          </div>
        ))}
      </div>
    )}
    
    {showLinkedin && validLinkedin && (
      <div>
        {linkedinUsernames.map((username) => (
          <div class={linkedinUsernames.length > 1 ? "mb-6 last:mb-0" : ""}>
            <LinkedInFeed 
              username={username}
              height={linkedinHeight}
              title={linkedinUsernames.length > 1 ? `${username}` : "Seguici su LinkedIn"}
            />
          </div>
        ))}
      </div>
    )}
    
    {showFacebook && validFacebook && (
      <div>
        {facebookUsernames.map((username) => (
          <div class={facebookUsernames.length > 1 ? "mb-6 last:mb-0" : ""}>
            <FacebookFeed 
              username={username}
              height={facebookHeight}
              title={facebookUsernames.length > 1 ? `${username}` : "Seguici su Facebook"}
            />
          </div>
        ))}
      </div>
    )}
  </div>
)}
