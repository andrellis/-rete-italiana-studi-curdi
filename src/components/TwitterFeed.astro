---
export interface Props {
  username: string;
  height?: number;
  theme?: 'light' | 'dark';
  title?: string;
  fallbackText?: string;
  mode?: 'embed' | 'link';
  href?: string; // optional direct URL (e.g., X List url)
}

const {
  username,
  height = 400,
  theme = 'light',
  title = "Seguici su X",
  fallbackText = "Seguici su X per rimanere informato su eventi e pubblicazioni.",
  mode = 'embed',
  href,
} = Astro.props;
---

<div class="bg-white rounded-lg shadow-md p-6">
  <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
    <svg class="w-6 h-6 mr-2 text-black" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M18.244 2H21l-6.57 7.507L22.5 22H15.93l-5.06-6.59L4.6 22H2l7.02-8.016L1.5 2h6.75l4.57 6.016L18.244 2Zm-1.19 18h1.8L7.08 4h-1.8l11.774 16Z"/></svg>
    {title}
  </h3>

  {mode === 'embed' ? (
    <div>
      <div class="x-timeline-container">
        <a
          class="twitter-timeline"
          data-height={height}
          data-theme={theme}
          data-chrome="nofooter"
          href={href || `https://twitter.com/${username}`}
        >
          {href ? 'Timeline X' : `Post di @${username}`}
        </a>
      </div>
      <div class="x-fallback hidden">
        <p class="text-gray-600 text-sm mb-4">
          {fallbackText}
        </p>
        <a
          href={href || `https://twitter.com/${username}`}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center px-4 py-2 bg-black text-white rounded-lg hover:opacity-90 transition-colors"
        >
          Vai al profilo @{username}
        </a>
      </div>
      <script is:inline async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      <script is:inline>
        document.addEventListener('DOMContentLoaded', function () {
          const ensureLoaded = () => {
            const twttr = window.twttr;
            if (twttr && twttr.widgets) {
              twttr.widgets.load();
            }
          };
          setTimeout(ensureLoaded, 300);

          setTimeout(function () {
            const box = document.querySelector('.x-timeline-container');
            const iframe = box && box.querySelector('iframe');
            const fallback = document.querySelector('.x-fallback');
            if (!iframe || iframe.offsetHeight === 0) {
              if (box) box.style.display = 'none';
              if (fallback) fallback.classList.remove('hidden');
            }
          }, 5000);
        });
      </script>
    </div>
  ) : (
    <div class="flex items-center justify-between">
      <p class="text-gray-600 text-sm">Seguici su X: @{username}</p>
      <a
        href={`https://twitter.com/${username}`}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center px-4 py-2 bg-black text-white rounded-lg hover:opacity-90 transition-colors"
      >
        Apri profilo
      </a>
    </div>
  )}
</div>

<style>
  .x-timeline-container { min-height: 400px; }
  .x-fallback {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 200px; text-align: center;
  }
  .twitter-timeline { border-radius: 0.5rem; }
</style>
